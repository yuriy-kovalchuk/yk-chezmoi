#!/bin/bash

# .install-packages.sh.tmpl hash: {{ include "run_onchange_install-packages.sh.tmpl" | sha256sum }}

# Helper to install Neovim from GitHub
install_nvim_github() {
    echo "Checking for latest Neovim stable release..."
    LATEST_TAG=$(curl -s https://api.github.com/repos/neovim/neovim/releases/latest | jq -r '.tag_name')
    CURRENT_VERSION=$(nvim --version 2>/dev/null | head -n 1 | awk '{print $2}')

    if [ "$LATEST_TAG" != "$CURRENT_VERSION" ]; then
        echo "Installing Neovim $LATEST_TAG from GitHub..."
        OS_TYPE=$(uname -s | tr '[:upper:]' '[:lower:]')
        ARCH=$(uname -m)
        
        # Normalize OS and ARCH for Neovim's release naming
        [ "$OS_TYPE" == "darwin" ] && NVIM_OS="macos" || NVIM_OS="linux"
        [ "$ARCH" == "aarch64" ] && NVIM_ARCH="arm64" || NVIM_ARCH="$ARCH"

        FILE_NAME="nvim-${NVIM_OS}-${NVIM_ARCH}.tar.gz"
        URL="https://github.com/neovim/neovim/releases/download/${LATEST_TAG}/${FILE_NAME}"

        echo "Downloading $URL..."
        curl -LO "$URL"
        
        # Extract and install
        # The tarball contains a directory like nvim-linux-x86_64/ or nvim-macos-arm64/
        tar xzf "$FILE_NAME"
        DIR_NAME=$(basename "$FILE_NAME" .tar.gz)
        
        {{ if eq .osid "darwin" -}}
        # For macOS, we can install to /usr/local
        sudo cp -R "${DIR_NAME}/"* /usr/local/
        {{ else -}}
        # For Linux
        sudo cp -R "${DIR_NAME}/"* /usr/local/
        {{ end -}}

        rm -rf "$FILE_NAME" "$DIR_NAME"
        echo "Neovim $LATEST_TAG installed successfully."
    else
        echo "Neovim $CURRENT_VERSION is already the latest stable version."
    fi
}

{{ if eq .osid "darwin" -}}
echo "Installing packages for macOS..."
brew install git htop jq yq unzip ripgrep lazygit llvm python3
install_nvim_github
{{ else if eq .osid "linux" -}}
echo "Installing packages for Linux..."

sudo apt update
sudo apt install -y software-properties-common build-essential g++ git btop htop jq yq clang clangd golang-go unzip ripgrep python3 python3-pip python3-venv curl zsh
install_nvim_github

# Set bash as default shell if not already
if [ "$SHELL" != "$(which bash)" ]; then
    echo "Changing default shell to bash..."
    sudo usermod -s "$(which bash)" "$USER"
fi

# Install Nix (required for devbox) if not present
if [ ! -d "/nix" ]; then
    echo "Installing Nix..."
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
fi

# Install Lazygit (Architecture-aware binary method for Linux)
if ! command -v lazygit &> /dev/null; then
    echo "Installing lazygit..."
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then LG_ARCH="x86_64"; else LG_ARCH="arm64"; fi
    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_${LG_ARCH}.tar.gz"
    tar xf lazygit.tar.gz lazygit
    sudo install lazygit /usr/local/bin
    rm lazygit lazygit.tar.gz
fi
{{ end -}}

# Install nvm and node LTS if not present
if [ ! -d "$HOME/.nvm" ]; then
    echo "Installing nvm..."
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install --lts
fi

# Install starship if not present
if ! command -v starship &> /dev/null; then
    echo "Installing starship prompt..."
    # Using 'yes' to pipe into the installer if it asks for confirmations
    # and using sudo explicitly since the installer tries to move to /usr/local/bin
    curl -sS https://starship.rs/install.sh | sudo sh -s -- -y
fi

# Install devbox if not present
if ! command -v devbox &> /dev/null; then
    echo "Installing devbox..."
    curl -fsSL https://get.jetify.com/devbox | bash -s -- -f
fi
